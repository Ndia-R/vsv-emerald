# ==============================================
# My Books アプリケーション - サーバー設定
# ==============================================

# WebP画像対応のための変数マップ
# Acceptヘッダーにwebpが含まれている場合、.webp拡張子を付与
map $http_accept $sebp_ext {
    default "";
    "~*webp" ".webp";
}

# ==============================================
# HTTPサーバー（HTTPSへのリダイレクト用）
# ==============================================
server {
    listen 80;
    # server_name vsv-emerald.skygroup.local;  # 本番環境用
    server_name localhost;  # 開発環境用
    
    # すべてのHTTPリクエストをHTTPSにリダイレクト（301 Moved Permanently）
    return 301 https://$host$request_uri;
}

# ==============================================
# HTTPSサーバー（メインサーバー）
# ==============================================
server {
    listen 443 ssl;
    http2 on;  # HTTP/2を有効化
    
    # server_name vsv-emerald.skygroup.local;  # 本番環境用
    server_name localhost;  # 開発環境用

    # SSL証明書の設定
    # ssl_certificate /etc/nginx/ssl/vsv-emerald_skygroup_local_2025.cer;      # 本番環境用
    # ssl_certificate_key /etc/nginx/ssl/vsv-emerald_skygroup_local_2025.key;  # 本番環境用

    ssl_certificate /etc/nginx/ssl/server.crt;      # 開発環境用（自己署名証明書）
    ssl_certificate_key /etc/nginx/ssl/server.key;  # 開発環境用（自己署名証明書）

    # ==============================================
    # フロントエンドアプリケーション（SPA対応）
    # ==============================================
    location / {
        root /usr/share/nginx/html;     # 静的ファイルのルートディレクトリ
        index index.html;               # デフォルトファイル
        try_files $uri /index.html;     # SPAルーティング：存在しないパスはindex.htmlにフォールバック

        # 静的アセットのキャッシュ設定
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|webp)$ {
            expires 30d;                                    # 30日間のブラウザキャッシュ
            add_header Cache-Control "public, no-transform"; # 公開キャッシュ、変換禁止
        }
    }

    # ==============================================
    # API 各バージョンへのリバースプロキシ設定
    # ==============================================
    
    location /api/v0/ {
        proxy_pass http://my-books-api-v0:8080/;            # Dockerコンテナ名でプロキシ
        proxy_set_header Host $host;                        # 元のHostヘッダーを転送
        proxy_set_header X-Real-IP $remote_addr;            # クライアントの実IPアドレス
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # プロキシチェーン情報
        proxy_set_header X-Forwarded-Proto $scheme;         # 元のプロトコル（https）
    }

    location /api/v1/ {
        proxy_pass http://my-books-api-v1:8080/;            # Dockerコンテナ名でプロキシ
        proxy_set_header Host $host;                        # 元のHostヘッダーを転送
        proxy_set_header X-Real-IP $remote_addr;            # クライアントの実IPアドレス
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # プロキシチェーン情報
        proxy_set_header X-Forwarded-Proto $scheme;         # 元のプロトコル（https）
    }

    location /api/v2/ {
        proxy_pass http://my-books-api-v2:8080/;            # Dockerコンテナ名でプロキシ
        proxy_set_header Host $host;                        # 元のHostヘッダーを転送
        proxy_set_header X-Real-IP $remote_addr;            # クライアントの実IPアドレス
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # プロキシチェーン情報
        proxy_set_header X-Forwarded-Proto $scheme;         # 元のプロトコル（https）
    }

    # ==============================================
    # Swagger UI 各バージョン
    # ==============================================

    # ============== Swagger UI v0 ==============
    # メインのSwagger UIページ
    location /swagger-ui/v0/ {
        proxy_pass http://my-books-api-v0:8080/swagger-ui/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Prefix /swagger-ui/v0;  # プレフィックス設定（重要）
    }

    # Swagger設定情報のエンドポイント
    location /swagger-ui/v0/v3/api-docs/swagger-config {
        proxy_pass http://my-books-api-v0:8080/v3/api-docs/swagger-config;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # OpenAPI仕様書のエンドポイント
    location /swagger-ui/v0/v3/api-docs {
        proxy_pass http://my-books-api-v0:8080/v3/api-docs;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ============== Swagger UI v1 ==============
    # メインのSwagger UIページ
    location /swagger-ui/v1/ {
        proxy_pass http://my-books-api-v1:8080/swagger-ui/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Prefix /swagger-ui/v1;  # プレフィックス設定（重要）
    }

    # Swagger設定情報のエンドポイント
    location /swagger-ui/v1/v3/api-docs/swagger-config {
        proxy_pass http://my-books-api-v1:8080/v3/api-docs/swagger-config;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # OpenAPI仕様書のエンドポイント
    location /swagger-ui/v1/v3/api-docs {
        proxy_pass http://my-books-api-v1:8080/v3/api-docs;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ============== Swagger UI v2 ==============
    # メインのSwagger UIページ
    location /swagger-ui/v2/ {
        proxy_pass http://my-books-api-v2:8080/swagger-ui/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Prefix /swagger-ui/v2;  # プレフィックス設定（重要）
    }

    # Swagger設定情報のエンドポイント
    location /swagger-ui/v2/v3/api-docs/swagger-config {
        proxy_pass http://my-books-api-v2:8080/v3/api-docs/swagger-config;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # OpenAPI仕様書のエンドポイント
    location /swagger-ui/v2/v3/api-docs {
        proxy_pass http://my-books-api-v2:8080/v3/api-docs;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ==============================================
    # 静的画像ファイルの配信（WebP最適化対応）
    # ==============================================
    location /images/ {
        alias /usr/share/nginx/html/images/;  # 画像ファイルの物理パス
        
        # WebP対応の画像配信ロジック：
        # 1. 元ファイル名に.webp拡張子を付けたWebP版があれば優先配信（例: image.jpg → image.jpg.webp）
        # 2. 元画像があれば配信
        # 3. どちらもなければno-imageのWebP版を配信
        # 注意：実際のWebPファイルは元ファイル名+.webpの形式で保存されている必要があります
        try_files $uri$sebp_ext $uri /images/no-image.png.webp;

        expires 6M;  # 6ヶ月間のブラウザキャッシュ（長期キャッシュ）
        add_header Cache-Control "public, no-transform";  # 公開キャッシュ、変換禁止
    }
}